# 問卷分析 on github.io with Jekyll theme hacker

<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

## 上傳
<div id="upload-file">
<input type="file" id="xlsxFile" accept=".xlsx" onchange="startProcessing()">
</div>

<div id="worksheetsInfo"></div>

<script>
type Question = { type: string, question: number };
type Answer = number;

interface MappingTable {
    q_maps: { [lang: string]: { [cell: string]: Question } };
    a_maps: { [lang: string]: { [cell: string]: Answer } };
}

interface Form {
    type: string;
    ans: number[];
}

function uploadFile(file: File): Promise<Uint8Array> {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            resolve(new Uint8Array(e.target.result as ArrayBuffer));
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
    });
}

function parseXLSX(data: Uint8Array) {
    return XLSX.read(data, {type: 'array'});
}

function createDict(sheetTranslate: any[][]): MappingTable {
    let q_maps: { [lang: string]: { [cell: string]: Question } } = {}; 
    let a_maps: { [lang: string]: { [cell: string]: Answer } } = {};
    let ordinal = 1;
    let question = 1;

    sheetTranslate.forEach((line, i) => {
        if (i === 0) return;
        let type = line[0];
        line.forEach((cell, j) => {
            if (j === 0) return;
            let lang = sheetTranslate[0][j];
            if (!q_maps[lang]) q_maps[lang] = {};
            if (!a_maps[lang]) a_maps[lang] = {};
            if (type) {
                q_maps[lang][cell] = { type: type, question: question++ };
                ordinal = 1;
            } else {
                a_maps[lang][cell] = ordinal++;
            }
        });
    });

    return { q_maps, a_maps };
}

function parseSurvey(sheet: any[][], mappingTable: MappingTable): Form[] {
    let forms: Form[] = [];
    let lang = sheet[0][0];
    sheet.forEach((line, i) => {
        if (i === 0) return;
        let form: Form = { type: lang, ans: [] };
        line.forEach((cell, j) => {
            let question = mappingTable.q_maps[lang][sheet[0][j]];
            form.type = question.type;
            let answers = cell.split(',').map(Number);
            answers.forEach(answer => {
                form.ans.push(mappingTable.a_maps[lang][answer]);
            });
        });
        forms.push(form);
    });

    return forms;
}

function drawPieChart(surveys: Form[], question_id: number) {
    let answers: { [answer: number]: number } = {};
    surveys.forEach(survey => {
        let answer = survey.ans[question_id];
        if (!answers[answer]) answers[answer] = 0;
        answers[answer]++;
    });

    new Chart(document.getElementById("pie-chart"), {
        type: 'pie',
        data: {
            labels: Object.keys(answers),
            datasets: [{
                data: Object.values(answers),
                backgroundColor: ...
            }]
        },
        options: {
            title: {
                display: true,
                text: 'Question ' + (question_id + 1)
            }
        }
    });
}

function drawHistogram(surveys: Form[], question_id: number) {
    // similar to DrawPieChart()
    // change 'pie' to 'bar' and adjust options accordingly
}

function listText(surveys: Form[], question_id: number) {
    surveys.forEach(survey => {
        console.log('Form', survey.type, 'Answer to Q' + (question_id + 1), ':', survey.ans[question_id]);
    });
}

async function startProcessing() {
    const xlsxFile = document.getElementById('xlsxFile') as HTMLInputElement;
    if (!xlsxFile.files) {
        console.error('No file selected!');
        return;
    }

    const data = await uploadFile(xlsxFile.files[0]);
    const workbook = parseXLSX(data);

    const mappingTable = createDict(workbook.Sheets['Translate']);

    const surveyPromises = workbook.SheetNames.map(sheetName => 
        sheetName !== 'Translate' ? parseSurvey(workbook.Sheets[sheetName], mappingTable) : null
    );
    
    const surveys = await Promise.all(surveyPromises);
    
    surveys.forEach(survey => {
        survey.questions.forEach((question, i) => {
            switch(question.type) {
                case 'Choice':
                    drawPieChart(survey, i);
                    break;
                case 'Checkbox':
                    drawHistogram(survey, i);
                    break;
                case 'Text':
                    listText(survey, i);
                    break;
                default:
                    console.error('Invalid question type:', question.type);
            }
        });
    });
}
</script>
