# 問卷分析 on github.io with Jekyll theme hacker

<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

## 上傳
<div id="upload-file">
<input type="file" id="xlsxFile" accept=".xlsx" onchange="startProcessing()">
</div>

<div id="worksheetsInfo"></div>

<script>
function uploadFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            resolve(new Uint8Array(e.target.result));
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
    });
}

function parseXLSX(data) {
    return XLSX.read(data, {type: 'array'});
}

function CreateDict(sheetTranslate) {
    var q_maps = {}; 
    var a_maps = {};
    var ordinal = 1;
    var question = 1;

    // assuming sheetTranslate is a 2D array
    sheetTranslate.forEach((line, i) => {
        if (i === 0) return;  // skip header
        var type = line[0];
        line.forEach((cell, j) => {
            if (j === 0) return;  // skip type
            var lang = sheetTranslate[0][j];  // assuming header contains language codes
            if (!q_maps[lang]) q_maps[lang] = {};
            if (!a_maps[lang]) a_maps[lang] = {};
            if (type) {  // if type is not empty
                q_maps[lang][cell] = { type: type, question: question++ };
                ordinal = 1;  // reset
            } else {  // if type is empty
                a_maps[lang][cell] = ordinal++;
            }
        });
    });

    return { q_maps, a_maps };
}

function ParseSurvey(sheet, mappingtable) {
    // assuming sheet is a 2D array and mappingtable contains q_maps and a_maps
    var forms = [];
    var lang = sheet[0][0];  // assuming language code is in cell A1
    sheet.forEach((line, i) => {
        if (i === 0) return;  // skip header
        var form = { type: lang, ans: [] };
        line.forEach((cell, j) => {
            var question = mappingtable.q_maps[lang][sheet[0][j]];
            form.type = question.type;
            var answers = cell.split(',').map(Number);
            answers.forEach(answer => {
                form.ans.push(mappingtable.a_maps[lang][answer]);
            });
        });
        forms.push(form);
    });

    return forms;
}

function DrawPieChart(surveys, question_id) {
    // assuming surveys is an array of forms and each form contains type and ans
    var answers = {};
    surveys.forEach(survey => {
        var answer = survey.ans[question_id];
        if (!answers[answer]) answers[answer] = 0;
        answers[answer]++;
    });

    // using Chart.js to draw pie chart
    new Chart(document.getElementById("pie-chart"), {
        type: 'pie',
        data: {
            labels: Object.keys(answers),
            datasets: [{
                data: Object.values(answers),
                backgroundColor: ... // define color set here
            }]
        },
        options: {
            title: {
                display: true,
                text: 'Question ' + (question_id + 1)
            }
        }
    });
}

function DrawHistogram(surveys, question_id) {
    // similar to DrawPieChart()
    // change 'pie' to 'bar' and adjust options accordingly
}

function ListText(surveys, question_id) {
    // print each answer
    surveys.forEach(survey => {
        console.log('Form', survey.type, 'Answer to Q' + (question_id + 1), ':', survey.ans[question_id]);
    });
}

async function startProcessing() {
    const xlsxFile = document.getElementById('xlsxFile').files[0];
    if (!xlsxFile) {
        console.error('No file selected!');
        return;
    }

    const data = await uploadFile(xlsxFile);
    const workbook = parseXLSX(data);

    const mappingTable = CreateDict(workbook.Sheets['Translate']);

    const surveyPromises = workbook.SheetNames.map(sheetName => 
        sheetName !== 'Translate' ? ParseSurvey(workbook.Sheets[sheetName], mappingTable) : null
    );
    
    const surveys = await Promise.all(surveyPromises);
    
    surveys.forEach(survey => {
        survey.questions.forEach((question, i) => {
            switch(question.type) {
                case 'Choice':
                    DrawPieChart(survey, i);
                    break;
                case 'Checkbox':
                    DrawHistogram(survey, i);
                    break;
                case 'Text':
                    ListText(survey, i);
                    break;
                default:
                    console.error('Invalid question type:', question.type);
            }
        });
    });
}
</script>
